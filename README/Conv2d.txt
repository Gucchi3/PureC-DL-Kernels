flowchart TD
    %% ノードのスタイル定義
    classDef process fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef decision fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef terminator fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px;
    classDef pointer fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,stroke-dasharray: 5 5;

    Start([Conv2d 関数開始]) --> CheckArgs{引数は有効か?<br/>input, weight, stride...}
    
    CheckArgs -- No --> Error1[エラー出力]:::error
    Error1 --> ReturnNull1([return NULL]):::terminator
    
    CheckArgs -- Yes --> CalcShape[出力形状計算<br/>H, W, C]:::process
    CalcShape --> CheckShape{出力サイズ > 0 ?}
    
    CheckShape -- No --> Error2[エラー出力]:::error
    Error2 --> ReturnNull1
    
    CheckShape -- Yes --> Alloc[出力Tensor メモリ確保]:::process
    Alloc --> CheckAlloc{確保成功 ?}
    
    CheckAlloc -- No --> Error3[エラー出力]:::error
    Error3 --> ReturnNull1
    
    CheckAlloc -- Yes --> InitPtr[ポインタ初期化<br/>weight_head = weight->data<br/>output_point = output->data]:::pointer
    InitPtr --> LoopH_Start

    %% H Loop
    subgraph Loop_H [H方向ループ]
        LoopH_Start{h < Output_H ?}:::decision
        LoopH_Start -- No --> EndFunc([return output_tensor]):::terminator
        LoopH_Start -- Yes --> LoopW_Start
        
        %% W Loop
        subgraph Loop_W [W方向ループ]
            LoopW_Start{w < Output_W ?}:::decision
            LoopW_Start -- No --> IncH[h++]:::process
            IncH --> LoopH_Start
            
            LoopW_Start -- Yes --> ResetWt[重みポインタ リセット<br/>weight_point = weight_head]:::pointer
            ResetWt --> CalcOrigin[入力基準座標計算<br/>in_lt_h, in_lt_w]:::process
            CalcOrigin --> LoopOC_Start

            %% OC Loop
            subgraph Loop_OC [出力CHループ]
                LoopOC_Start{oc < Output_C ?}:::decision
                LoopOC_Start -- No --> IncW[w++]:::process
                IncW --> LoopW_Start
                
                LoopOC_Start -- Yes --> InitSum[sum = 0.0f]:::process
                InitSum --> LoopKH_Start
                
                %% Kernel Loops
                subgraph Loop_Kernel [カーネルループ KH, KW]
                    LoopKH_Start{kh < Kernel_Size ?}:::decision
                    LoopKH_Start -- No --> StoreSum[結果格納<br/>*output_point++ = sum]:::pointer
                    StoreSum --> IncOC[oc++]:::process
                    IncOC --> LoopOC_Start
                    
                    LoopKH_Start -- Yes --> LoopKW_Start{kw < Kernel_Size ?}:::decision
                    LoopKW_Start -- No --> IncKH[kh++]:::process
                    IncKH --> LoopKH_Start
                    
                    LoopKW_Start -- Yes --> CalcInPos[参照座標計算<br/>in_h, in_w]:::process
                    CalcInPos --> CheckPad{パディング領域か?<br/>範囲外チェック}:::decision
                    
                    %% Padding Logic
                    CheckPad -- Yes:範囲外 --> SkipPtr[ポインタ空送り<br/>weight_point += Input_C]:::pointer
                    SkipPtr --> ContinueKW[continue]
                    
                    %% Main Calculation
                    CheckPad -- No:範囲内 --> SetInPtr[入力ポインタ設定<br/>in_point計算]:::pointer
                    SetInPtr --> CalcDotProd[積和演算ループ<br/>sum += *in_point++ * *weight_point++]:::process
                    CalcDotProd --> ContinueKW
                    
                    ContinueKW --> IncKW[kw++]:::process
                    IncKW --> LoopKW_Start
                end
            end
        end
    end